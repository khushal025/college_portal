<!DOCTYPE html>
<html>
<head>
  <title>Teacher Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial;background:linear-gradient(135deg,#1a1a2e,#16213e);color:#fff;overflow-x:hidden;min-height:100vh}
    .header{display:flex;justify-content:space-between;align-items:center;padding:24px 16px;background:rgba(15,23,42,.6);backdrop-filter:blur(8px)}
    .back-btn{background:#e53e3e;color:#fff;border:none;padding:.75rem 1.5rem;border-radius:10px;cursor:pointer;font-weight:600;text-decoration:none;transition:.3s}
    .back-btn:hover{background:#c53030;transform:translateY(-1px)}
    .hamburger{position:fixed;top:24px;right:24px;z-index:1000;background:#7c3aed;border:none;padding:12px;border-radius:8px;cursor:pointer;transition:.3s}
    .hamburger:hover{background:#6d28d9;transform:scale(1.05)} .hamburger .line{width:20px;height:2px;background:#fff;margin:4px 0}
    .slide-menu{position:fixed;top:0;right:-300px;width:280px;height:100vh;background:rgba(15,23,42,.95);backdrop-filter:blur(10px);border-left:1px solid rgba(255,255,255,.1);transition:right .3s;z-index:999;padding-top:80px}
    .slide-menu.active{right:0}
    .menu-section{padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.1)}
    .menu-title{font-size:14px;font-weight:600;color:#94a3b8;margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px}
    .menu-item{display:block;padding:10px 8px;color:#fff;text-decoration:none;font-size:16px;transition:.2s;border-radius:4px;cursor:pointer;border:none;background:none;width:100%;text-align:left}
    .menu-item:hover{background:rgba(124,58,237,.2);color:#c4b5fd;transform:translateX(4px)}
    .main-content{padding:32px 24px;max-width:1200px;margin:0 auto}
    .welcome-section{text-align:center;margin-bottom:48px}
    .welcome-section h2{font-size:28px;margin-bottom:8px;background:linear-gradient(135deg,#c4b5fd,#7c3aed);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .welcome-section p{color:#94a3b8;font-size:16px}
    .search-section{text-align:center;margin-bottom:32px;background:rgba(255,255,255,.08);border-radius:12px;padding:24px;border:1px solid rgba(255,255,255,.1)}
    .search-input{width:300px;padding:12px 16px;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.1);color:#fff;font-size:16px;margin-right:12px}
    .search-input::placeholder{color:#94a3b8}
    .load-btn{background:#7c3aed;color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:600;font-size:16px;transition:.3s}
    .load-btn:hover{background:#6d28d9;transform:translateY(-1px)}
    .upload-section{background:rgba(255,255,255,.05);border-radius:12px;padding:24px;margin-bottom:32px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1)}
    .upload-section h3{margin-bottom:16px;color:#e2e8f0}
    .file-upload{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .file-input{flex:1;padding:12px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:8px;color:#fff;font-size:14px}
    .upload-btn{background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:600;transition:.3s}
    .upload-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(124,58,237,.3)}
    .dashboard-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:24px;margin-top:24px}
    .dashboard-card{background:rgba(255,255,255,.08);border-radius:12px;padding:24px;border:1px solid rgba(255,255,255,.1)}
    .card-title{font-size:18px;font-weight:600;margin-bottom:16px;color:#e2e8f0}
    .no-data{color:#94a3b8;font-style:italic;text-align:center;padding:2rem}
    .btn-group{display:flex;gap:12px;margin-top:16px}
    .reload-btn{background:#06b6d4;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px}
    .save-btn{background:#059669;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px}
    @media(max-width:768px){.dashboard-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="header">
    <a href="/" class="back-btn">‚Üê Back</a>
    <h1>üéì Hello Prof. {{ teacher_name }}</h1>
  </div>

  <button class="hamburger" onclick="toggleSlideMenu()"><div class="line"></div><div class="line"></div><div class="line"></div></button>

  <div class="slide-menu" id="slideMenu">
    <div class="menu-section">
      <div class="menu-title">Upload Options</div>
      <button class="menu-item" onclick="showUploadAttendance()">üìä Upload Attendance</button>
      <button class="menu-item" onclick="showUploadResults()">üìã Upload Results</button>
    </div>
    <div class="menu-section">
      <div class="menu-title">Quick Actions</div>
      <button class="menu-item" onclick="generateReports()">üìà Generate Reports</button>
      <button class="menu-item" onclick="manageStudents()">üë• Manage Students</button>
    </div>
  </div>

  <div class="main-content">
    <div class="welcome-section">
      <h2 style="text-align:center;">Hello {{ teacher_name }}</h2>
      <p style="text-align:center;">{{ teacher_email }}</p>
      <p style="text-align:center;">Secure portal for teachers to manage students, attendance and results</p>
    </div>

    <div class="search-section">
      <h3 style="color:#e2e8f0;margin-bottom:16px;">üîç Search Student</h3>
      <input type="text" id="rollNoSearch" class="search-input" placeholder="Enter student Roll No">
      <button class="load-btn" onclick="loadStudent()">Search</button>
    </div>

    <div class="upload-section" id="uploadSection" style="display:none;">
      <div id="attendanceUpload" style="display:none;">
        <h3>üìä Upload Attendance (.csv/.xlsx)</h3>
        <div class="file-upload">
          <input type="file" class="file-input" id="attendanceFile" accept=".csv,.xlsx,.xls">
          <button class="upload-btn" onclick="uploadAttendance()">Upload Attendance</button>
        </div>
        <div id="uploadResult" style="margin-top:10px;"></div>
      </div>

      <div id="resultsUpload" style="display:none;">
        <h3>üìã Upload Results (.csv/.xlsx)</h3>
        <div class="file-upload">
          <input type="file" class="file-input" id="resultsFile" accept=".csv,.xlsx,.xls">
          <button class="upload-btn" onclick="uploadResults()">Upload Results</button>
        </div>
        <div id="resultsUploadResult" style="margin-top:10px;"></div>
      </div>
    </div>

    <div class="dashboard-grid">
      <div class="dashboard-card">
        <h3 class="card-title">üë§ Profile</h3>
        <div id="profileContent">
          <p class="no-data">No student loaded</p>
          <div class="btn-group">
            <button class="reload-btn" onclick="reloadProfile()">Reload</button>
            <button class="save-btn">Save Changes</button>
          </div>
        </div>
      </div>

      <div class="dashboard-card">
        <h3 class="card-title">üìä Results</h3>
        <div id="resultsContent">
          <p class="no-data">No student loaded</p>
          <div class="btn-group">
            <button class="reload-btn" onclick="reloadResults()">Reload</button>
            <button class="save-btn">Save Results</button>
          </div>
        </div>
      </div>

      <div class="dashboard-card">
        <h3 class="card-title">üìÖ Attendance</h3>
        <div id="attendanceContent">
          <p class="no-data">No student loaded</p>
          <div class="btn-group">
            <button class="reload-btn" onclick="reloadAttendance()">Reload</button>
            <button class="save-btn" onclick="saveAttendanceChanges()">Save Changes</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  let currentStudentRoll = null;

  function toggleSlideMenu(){ document.getElementById('slideMenu').classList.toggle('active'); }
  function showUploadAttendance(){
    document.getElementById('uploadSection').style.display='block';
    document.getElementById('attendanceUpload').style.display='block';
    document.getElementById('resultsUpload').style.display='none';
    document.getElementById('slideMenu').classList.remove('active');
  }
  function showUploadResults(){
    document.getElementById('uploadSection').style.display='block';
    document.getElementById('resultsUpload').style.display='block';
    document.getElementById('attendanceUpload').style.display='none';
    document.getElementById('slideMenu').classList.remove('active');
  }

  async function loadStudent(){
    const rollNo = document.getElementById('rollNoSearch').value.trim();
    if(!rollNo){ alert('Please enter roll number!'); return; }
    currentStudentRoll = rollNo;
    try{
      const res = await fetch(`/api/get_student_data/${rollNo}`);
      const out = await res.json();
      if(out.success){ displayStudentData(out.data); }
      else{ alert('Student not found!'); }
    }catch(e){ alert('Error loading student data!'); }
  }

  function displayStudentData(data){
    const { student, results, attendance } = data;
    if(student){
      document.getElementById('profileContent').innerHTML = `
        <div style="text-align:left;">
          <div style="margin-bottom:10px;"><strong>Name:</strong>
            <input type="text" id="edit_name" value="${student.student_name||''}" style="background:rgba(255,255,255,.1);border:1px solid #ccc;padding:5px;border-radius:4px;color:#fff;width:200px;">
          </div>
          <div style="margin-bottom:10px;"><strong>Roll No:</strong> ${student.roll_no||'N/A'} (Cannot edit)</div>
          <div style="margin-bottom:10px;"><strong>Father Name:</strong>
            <input type="text" id="edit_father" value="${student.father_name||''}" style="background:rgba(255,255,255,.1);border:1px solid #ccc;padding:5px;border-radius:4px;color:#fff;width:200px;">
          </div>
          <div style="margin-bottom:10px;"><strong>Course:</strong>
            <input type="text" id="edit_course" value="${student.course||''}" style="background:rgba(255,255,255,.1);border:1px solid #ccc;padding:5px;border-radius:4px;color:#fff;width:200px;">
          </div>
          <div style="margin-bottom:10px;"><strong>Semester:</strong>
            <input type="text" id="edit_semester" value="${student.semester||''}" style="background:rgba(255,255,255,.1);border:1px solid #ccc;padding:5px;border-radius:4px;color:#fff;width:200px;">
          </div>
          <div style="margin-bottom:10px;"><strong>Email:</strong>
            <input type="text" id="edit_email" value="${student.email||''}" style="background:rgba(255,255,255,.1);border:1px solid #ccc;padding:5px;border-radius:4px;color:#fff;width:200px;">
          </div>
          <div class="btn-group">
            <button class="reload-btn" onclick="reloadProfile()">Reload</button>
            <button class="save-btn" onclick="saveProfileChanges('${student.roll_no}')">Save Changes</button>
          </div>
        </div>`;
    }
    if(results){
      let html = '<div style="text-align:left;">';
      for(const [k,v] of Object.entries(results)){
        if(['roll_no','student_name','father_name'].includes(k)) continue;
        html += `<p><strong>${k}:</strong> ${v}</p>`;
      }
      html += `<div class="btn-group"><button class="reload-btn" onclick="reloadResults()">Reload</button>
               <button class="save-btn">Save Results</button></div></div>`;
      document.getElementById('resultsContent').innerHTML = html;
    }
    const att = attendance || {};
    document.getElementById('attendanceContent').innerHTML = `
      <div style="text-align:left;">
        ${['OOPUI','cloud_comp','bi','foai','se','java_script_lab','total_attendance'].map(id=>{
          const label = ({OOPUI:'OOPUI',cloud_comp:'Cloud Comp',bi:'BI',foai:'FOAI',se:'SE',java_script_lab:'JS Lab',total_attendance:'Total'})[id];
          const val = (att[id]||0);
          return `<div style="margin-bottom:8px;"><strong>${label}:</strong>
            <input type="number" id="att_${id}" value="${val}" style="background:rgba(255,255,255,.1);border:1px solid #ccc;padding:4px;border-radius:4px;color:#fff;width:80px;"></div>`;
        }).join('')}
        <div class="btn-group">
          <button class="reload-btn" onclick="reloadAttendance()">Reload</button>
          <button class="save-btn" onclick="saveAttendanceChanges()">Save Changes</button>
        </div>
      </div>`;
  }

  async function saveProfileChanges(rollNo){
    const payload = {
      roll_no: rollNo,
      student_name: document.getElementById('edit_name').value,
      father_name: document.getElementById('edit_father').value,
      course: document.getElementById('edit_course').value,
      semester: document.getElementById('edit_semester').value,
      email: document.getElementById('edit_email').value
    };
    try{
      const res = await fetch('/update_student_profile',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const out = await res.json();
      alert(out.success ? 'Profile updated' : ('Update failed: '+(out.message||'')));
      if(out.success) loadStudent();
    }catch(e){ alert('Error saving profile'); }
  }

  async function saveAttendanceChanges(){
    if(!currentStudentRoll){ alert('Please load a student first!'); return; }
    const get = id => document.getElementById('att_'+id).value || 0;
    const payload = {
      roll_no: currentStudentRoll,
      OOPUI: get('OOPUI'),
      cloud_comp: get('cloud_comp'),
      bi: get('bi'),
      foai: get('foai'),
      se: get('se'),
      java_script_lab: get('java_script_lab'),
      total_attendance: get('total_attendance')
    };
    try{
      const res = await fetch('/update_student_attendance',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const out = await res.json();
      alert(out.success ? 'Attendance updated' : ('Update failed: '+(out.message||'')));
      if(out.success) loadStudent();
    }catch(e){ alert('Error saving attendance'); }
  }

  // CRITICAL: use files, do not set Content-Type manually
  async function uploadAttendance(){
    const input = document.getElementById('attendanceFile');
    if(!input || input.files.length===0){
      document.getElementById('uploadResult').innerHTML = '<p style="color:#e74c3c;">Please select a file!</p>'; return;
    }
    const fd = new FormData();
    fd.append('file', input.files);  // [21]
    try{
      const res = await fetch('/upload_attendance',{method:'POST',body:fd});  // [2]
      const out = await res.json();
      document.getElementById('uploadResult').innerHTML = out.success
        ? `<p style="color:#27ae60;">Attendance uploaded. Inserted: ${out.summary.inserted}, Updated: ${out.summary.updated}, Skipped: ${out.summary.skipped}</p>`
        : `<p style="color:#e74c3c;">${out.message||'Failed'}</p>`;
    }catch(e){
      document.getElementById('uploadResult').innerHTML = '<p style="color:#e74c3c;">Upload failed!</p>';
    }
  }

  async function uploadResults(){
    const input = document.getElementById('resultsFile');
    if(!input || input.files.length===0){
      document.getElementById('resultsUploadResult').innerHTML = '<p style="color:#e74c3c;">Please select a file!</p>'; return;
    }
    const fd = new FormData();
    fd.append('file', input.files);  // [21]
    try{
      const res = await fetch('/upload_results',{method:'POST',body:fd});  // [2]
      const out = await res.json();
      document.getElementById('resultsUploadResult').innerHTML = out.success
        ? `<p style="color:#27ae60;">Results uploaded. Inserted: ${out.summary.inserted}, Updated: ${out.summary.updated}, Skipped: ${out.summary.skipped}</p>`
        : `<p style="color:#e74c3c;">${out.message||'Failed'}</p>`;
    }catch(e){
      document.getElementById('resultsUploadResult').innerHTML = '<p style="color:#e74c3c;">Upload failed!</p>';
    }
  }

  function reloadProfile(){ loadStudent(); }
  function reloadResults(){ loadStudent(); }
  function reloadAttendance(){ loadStudent(); }

  function generateReports(){ alert('Generate Reports feature coming soon!'); }
  function manageStudents(){ alert('Manage Students feature coming soon!'); }

  document.addEventListener('click', (e)=>{
    const slideMenu = document.getElementById('slideMenu');
    const hamburger = document.querySelector('.hamburger');
    if (!slideMenu.contains(e.target) && !hamburger.contains(e.target)) {
      slideMenu.classList.remove('active');
    }
  });
</script>
</body>
</html>
